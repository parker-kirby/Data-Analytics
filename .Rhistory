#obtain our tsne model with pca = true
tsne<-Rtsne(master,pca = T,perplexity=10,check_duplicates = F)
setwd("~/IAPP/Data-Analytics")
library(data.table)
library(dplyr)
library(carat)
#read in our data
data <- fread('./UNH_Membership_Project/project/volume/data/raw/raw_data.csv')
#removing records that won't be used for analysis
data <- distinct(data)
data <- data[data$`Account Record Type` == "Individual"]
data <- data[data$`Membership Category` == "Individual"]
data <- data[data$Status == "Active"]
data <- data[data$`Member Type` != "Individual Green Membership"]
data <- data[data$`Member Type` != "Press"]
data <- data[data$`Product: Record Type` != "Donation"]
data <- data[data$`Product: Record Type` != "Coupon"]
#Converting date formats and specifying our date range
data$`Created Date`<- as.Date(data$`Created Date`, "%m/%d/%Y")
data$`Transaction Date` <- as.Date(data$`Transaction Date`, "%m/%d/%Y")
data <- data[data$`Transaction Date` < as.Date('2022-01-01')]
###############CASE######################
data_2 <- data[data$`Order Id` == "Order 0432947"]
View(data_2)
#read in our data
data <- fread('./UNH_Membership_Project/project/volume/data/raw/raw_data.csv')
#removing records that won't be used for analysis
data <- distinct(data)
data <- data[data$`Account Record Type` == "Individual"]
data <- data[data$`Membership Category` == "Individual"]
data <- data[data$Status == "Active"]
data <- data[data$`Member Type` != "Individual Green Membership"]
data <- data[data$`Member Type` != "Press"]
data <- data[data$`Product: Record Type` != "Donation"]
data <- data[data$`Product: Record Type` != "Coupon"]
#Converting date formats and specifying our date range
data$`Created Date`<- as.Date(data$`Created Date`, "%m/%d/%Y")
data$`Transaction Date` <- as.Date(data$`Transaction Date`, "%m/%d/%Y")
data <- data[data$`Transaction Date` < as.Date('2022-01-01')]
#removing columns that aren't important
remove <- c("OTP", "Designation", "Default Country", "Product: Short Name", "Account Safe Id",
"Account Safe Id-1", "Account Record Type-1", "Member-1", "Member Type-1", "Status",
"Person Account: Lead Source", "Certified", "Member")
data <- data[, remove:=NULL, with=FALSE]
#writing out our cleaned data
fwrite(data, './UNH_Membership_Project/project/volume/data/interim/cleaned_data.csv')
data <- fread('./UNH_Membership_Project/project/volume/data/intrim/cleaned_data.csv')
data <- fread('./UNH_Membership_Project/project/volume/data/intrim/cleaned_data.csv')
membership_list = c("Professional", "Not-For-Profit", "Government", "Higher Education", "Retired", "Transitional", "Student")
##########################################################################################################
#Direct membership
data_list <- data[(duplicated(data$`Order Id`) | duplicated(data$`Order Id`, fromLast = TRUE)) & data$`Unit Price` == 0]
#data$direct[data$`Product: Product Name` %in% direct_list & data$`Unit Price` > 0 & data$`Total Payment` >= data$`Unit Price`] <- 1
direct <- data[data$`Product: Product Name` %in% membership_list & data$`Unit Price` > 0 & data$`Total Payment` >= data$`Unit Price`]
#Get rid of records in data list
non_use = c(data_list$`Order Id`)
'%notin%' <- Negate('%in%')
Final_Direct <- direct[direct$`Order Id` %notin% non_use]
View(Final_Direct)
data_1 <- data[data$`Order Id` == "Order 0031865"]
View(data_1)
View(data_list)
data_1 <- data[data$`Order Id` == "Order 0188223"]
View(data_1)
##########################################################################################################
#Direct membership
data_list <- data[(duplicated(data$`Order Id`) | duplicated(data$`Order Id`, fromLast = TRUE)) & data$`Unit Price` == 0 & data$`Product: Category` == "Book"]
View(data_list)
data_1 <- data[data$`Order Id` == "Order 0637456"]
bundle1 <- data[data$`Product: Product Name` %in% membership_list & (duplicated(data$`Order Id`) | duplicated(data$`Order Id`, fromLast = TRUE)) & data$`Unit Price` == 0 & data$`Total Payment` > 0]
bundle1[bundle1$`Order Id` == "Order 0637456"]
data_1 <- data[data$`Order Id` == "Order 0627314"]
data_1 <- data[data$`Order Id` == "Order 0571168"]
data_1 <- data[data$`Order Id` == "Order 0269062"]
#read in our data
data <- fread('./UNH_Membership_Project/project/volume/data/raw/raw_data.csv')
#removing records that won't be used for analysis
data <- distinct(data)
data <- data[data$`Account Record Type` == "Individual"]
data <- data[data$`Membership Category` == "Individual"]
data <- data[data$Status == "Active"]
data <- data[data$`Member Type` != "Individual Green Membership"]
data <- data[data$`Member Type` != "Press"]
data <- data[data$`Product: Record Type` != "Donation"]
data <- data[data$`Product: Record Type` != "Coupon"]
data <- data[data$`Product: Category` != "Book" & data$`Unit Price` != 0]
#Converting date formats and specifying our date range
data$`Created Date`<- as.Date(data$`Created Date`, "%m/%d/%Y")
data$`Transaction Date` <- as.Date(data$`Transaction Date`, "%m/%d/%Y")
data <- data[data$`Transaction Date` < as.Date('2022-01-01')]
data6 <- data[data$`Product: Category` == "Book" & data$`Unit Price` == 0]
#read in our data
data <- fread('./UNH_Membership_Project/project/volume/data/raw/raw_data.csv')
#removing records that won't be used for analysis
data <- distinct(data)
data <- data[data$`Account Record Type` == "Individual"]
data <- data[data$`Membership Category` == "Individual"]
data <- data[data$Status == "Active"]
data <- data[data$`Member Type` != "Individual Green Membership"]
data <- data[data$`Member Type` != "Press"]
data <- data[data$`Product: Record Type` != "Donation"]
data <- data[data$`Product: Record Type` != "Coupon"]
data6 <- data[data$`Product: Category` == "Book" & data$`Unit Price` == 0]
View(data6)
data_1 <- data[data$`Order Id` == "Order 0309145"]
#read in our data
data <- fread('./UNH_Membership_Project/project/volume/data/raw/raw_data.csv')
#removing records that won't be used for analysis
data <- distinct(data)
data <- data[data$`Account Record Type` == "Individual"]
data <- data[data$`Membership Category` == "Individual"]
data <- data[data$Status == "Active"]
data <- data[data$`Member Type` != "Individual Green Membership"]
data <- data[data$`Member Type` != "Press"]
data <- data[data$`Product: Record Type` != "Donation"]
data <- data[data$`Product: Record Type` != "Coupon"]
data <- data[(data$`Product: Category` != "Book" & data$`Unit Price` != 0)]
View(data)
#read in our data
data <- fread('./UNH_Membership_Project/project/volume/data/raw/raw_data.csv')
#removing records that won't be used for analysis
data <- distinct(data)
data <- data[data$`Account Record Type` == "Individual"]
data <- data[data$`Membership Category` == "Individual"]
data <- data[data$Status == "Active"]
data <- data[data$`Member Type` != "Individual Green Membership"]
data <- data[data$`Member Type` != "Press"]
data <- data[data$`Product: Record Type` != "Donation"]
data <- data[data$`Product: Record Type` != "Coupon"]
data <- data[!(data$`Product: Category` == "Book" & data$`Unit Price` == 0)]
#Converting date formats and specifying our date range
data$`Created Date`<- as.Date(data$`Created Date`, "%m/%d/%Y")
data$`Transaction Date` <- as.Date(data$`Transaction Date`, "%m/%d/%Y")
data <- data[data$`Transaction Date` < as.Date('2022-01-01')]
#removing columns that aren't important
remove <- c("OTP", "Designation", "Default Country", "Product: Short Name", "Account Safe Id",
"Account Safe Id-1", "Account Record Type-1", "Member-1", "Member Type-1", "Status",
"Person Account: Lead Source", "Certified", "Member")
data <- data[, remove:=NULL, with=FALSE]
#writing out our cleaned data
fwrite(data, './UNH_Membership_Project/project/volume/data/interim/cleaned_data.csv')
data <- fread('./UNH_Membership_Project/project/volume/data/intrim/cleaned_data.csv')
membership_list = c("Professional", "Not-For-Profit", "Government", "Higher Education", "Retired", "Transitional", "Student")
##########################################################################################################
#Direct membership
data_list <- data[(duplicated(data$`Order Id`) | duplicated(data$`Order Id`, fromLast = TRUE)) & data$`Unit Price` == 0 & data$`Product: Category` == "Book"]
#data$direct[data$`Product: Product Name` %in% direct_list & data$`Unit Price` > 0 & data$`Total Payment` >= data$`Unit Price`] <- 1
direct <- data[data$`Product: Product Name` %in% membership_list & data$`Unit Price` > 0 & data$`Total Payment` >= data$`Unit Price`]
#Get rid of records in data list
non_use = c(data_list$`Order Id`)
'%notin%' <- Negate('%in%')
Final_Direct <- direct[direct$`Order Id` %notin% non_use]
data <- fread('./UNH_Membership_Project/project/volume/data/intrim/cleaned_data.csv')
membership_list = c("Professional", "Not-For-Profit", "Government", "Higher Education", "Retired", "Transitional", "Student")
##########################################################################################################
#Direct membership
data_list <- data[(duplicated(data$`Order Id`) | duplicated(data$`Order Id`, fromLast = TRUE)) & data$`Unit Price` == 0]
#data$direct[data$`Product: Product Name` %in% direct_list & data$`Unit Price` > 0 & data$`Total Payment` >= data$`Unit Price`] <- 1
direct <- data[data$`Product: Product Name` %in% membership_list & data$`Unit Price` > 0 & data$`Total Payment` >= data$`Unit Price`]
#Get rid of records in data list
non_use = c(data_list$`Order Id`)
'%notin%' <- Negate('%in%')
Final_Direct <- direct[direct$`Order Id` %notin% non_use]
OTP_indirect <- data[(duplicated(data$`Order Id`) | duplicated(data$`Order Id`, fromLast = TRUE)) & data$`Unit Price` == 0 & data$`Total Payment` == 0]
Final_OTP <- test_indirect[test_indirect$`Product: Product Name` %in% membership_list]
OTP_indirect <- data[(duplicated(data$`Order Id`) | duplicated(data$`Order Id`, fromLast = TRUE)) & data$`Unit Price` == 0 & data$`Total Payment` == 0]
Final_OTP <- OTP_indirect[OTP_indirect$`Product: Product Name` %in% membership_list]
#########################################################################################################
#Indirect Comp
comped1 <- data[data$`Product: Product Name` %in% membership_list & data$`Unit Price` > 0 & data$`Total Payment` == 0]
comped2 <- data[data$`Product: Product Name` %in% membership_list & data$`Unit Price` == 0 & data$`Total Payment` == 0 & !(duplicated(data$`Order Id`) | duplicated(data$`Order Id`, fromLast = TRUE))]
Final_Comp<- rbind(comped1, comped2)
bundle1 <- data[data$`Product: Product Name` %in% membership_list & (duplicated(data$`Order Id`) | duplicated(data$`Order Id`, fromLast = TRUE)) & data$`Unit Price` == 0 & data$`Total Payment` > 0]
bundle1[bundle1$`Order Id` == "Order 0637456"]
bundle2 <- data[data$`Product: Product Name` %in% membership_list & (duplicated(data$`Order Id`) | duplicated(data$`Order Id`, fromLast = TRUE)) & data$`Unit Price`> 0 & data$`Total Payment`> 0 & data$`Unit Price` <= data$`Total Payment`]
bundle2 <- bundle2[bundle2$`Order Id` %in% non_use]
Final_Bundle <- rbind(bundle1, bundle2)
View(Final_Bundle)
data_1 <- data[data$`Order Id` == "Order 0597106"]
data_1 <- data[data$`Order Id` == "Order 0440537"]
Final_Bundle <- distinct(Final_Bundle)
bundle1 <- data[data$`Product: Product Name` %in% membership_list & (duplicated(data$`Order Id`) | duplicated(data$`Order Id`, fromLast = TRUE)) & data$`Unit Price` == 0 & data$`Total Payment` > 0]
bundle1[bundle1$`Order Id` == "Order 0637456"]
bundle2 <- data[data$`Product: Product Name` %in% membership_list & (duplicated(data$`Order Id`) | duplicated(data$`Order Id`, fromLast = TRUE)) & data$`Unit Price`> 0 & data$`Total Payment`> 0 & data$`Unit Price` <= data$`Total Payment`]
bundle2 <- bundle2[bundle2$`Order Id` %in% non_use]
Final_Bundle <- rbind(bundle1, bundle2)
Final_Bundle <- distinct(Final_Bundle)
Final_Bundle <- distinct(Final_Bundle$`Order Id`)
Final_Bundle <- rbind(bundle1, bundle2)
Final_Bundle <- Final_Bundle(!(duplicated(Final_Bundle$`Order Id`) | duplicated(Final_Bundle$`Order Id`, fromLast = TRUE)))
Final_Bundle <- Final_Bundle(! (duplicated(Final_Bundle$`Order Id`) | duplicated(Final_Bundle$`Order Id`, fromLast = TRUE)))
Final_Bundle <- Final_Bundle[(! (duplicated(Final_Bundle$`Order Id`) | duplicated(Final_Bundle$`Order Id`, fromLast = TRUE)))]
View(Final_Bundle)
bundle1 <- data[data$`Product: Product Name` %in% membership_list & (duplicated(data$`Order Id`) | duplicated(data$`Order Id`, fromLast = TRUE)) & data$`Unit Price` == 0 & data$`Total Payment` > 0]
bundle1[bundle1$`Order Id` == "Order 0637456"]
bundle2 <- data[data$`Product: Product Name` %in% membership_list & (duplicated(data$`Order Id`) | duplicated(data$`Order Id`, fromLast = TRUE)) & data$`Unit Price`> 0 & data$`Total Payment`> 0 & data$`Unit Price` <= data$`Total Payment`]
bundle2 <- bundle2[bundle2$`Order Id` %in% non_use]
Final_Bundle <- rbind(bundle1, bundle2)
Final_Bundle <- Final_Bundle[( (duplicated(Final_Bundle$`Order Id`) | duplicated(Final_Bundle$`Order Id`, fromLast = TRUE)))]
Final_Bundle <- Final_Bundle[(!(duplicated(Final_Bundle$`Order Id`) | duplicated(Final_Bundle$`Order Id`, fromLast = TRUE)))]
bundle1 <- data[data$`Product: Product Name` %in% membership_list & (duplicated(data$`Order Id`) | duplicated(data$`Order Id`, fromLast = TRUE)) & data$`Unit Price` == 0 & data$`Total Payment` > 0]
bundle1[bundle1$`Order Id` == "Order 0637456"]
bundle2 <- data[data$`Product: Product Name` %in% membership_list & (duplicated(data$`Order Id`) | duplicated(data$`Order Id`, fromLast = TRUE)) & data$`Unit Price`> 0 & data$`Total Payment`> 0 & data$`Unit Price` <= data$`Total Payment`]
bundle2 <- bundle2[bundle2$`Order Id` %in% non_use]
Final_Bundle <- rbind(bundle1, bundle2)
Final_Bundle <- Final_Bundle[(!(duplicated(Final_Bundle$`Order Id`) | duplicated(Final_Bundle$`Order Id`, fromLast = TRUE)))]
Final_Bundle[Final_Bundle$`Order Id` == "Order 0146589"]
dta <- Final_Bundle[Final_Bundle$`Order Id` == "Order 0146589"]
View(dta)
bundle1 <- data[data$`Product: Product Name` %in% membership_list & (duplicated(data$`Order Id`) | duplicated(data$`Order Id`, fromLast = TRUE)) & data$`Unit Price` == 0 & data$`Total Payment` > 0]
bundle1[bundle1$`Order Id` == "Order 0637456"]
bundle2 <- data[data$`Product: Product Name` %in% membership_list & (duplicated(data$`Order Id`) | duplicated(data$`Order Id`, fromLast = TRUE)) & data$`Unit Price`> 0 & data$`Total Payment`> 0 & data$`Unit Price` <= data$`Total Payment`]
bundle2 <- bundle2[bundle2$`Order Id` %in% non_use]
Final_Bundle <- rbind(bundle1, bundle2)
Final_Bundle <- Final_Bundle[(!(duplicated(Final_Bundle$`Order Id`)))]
dta <- Final_Bundle[Final_Bundle$`Order Id` == "Order 0146589"]
View(dta)
dta <- data[!(data$`Product: Category` == "eBook" & data$`Unit Price` == 0)]
dta <- data[(data$`Product: Category` == "eBook" & data$`Unit Price` == 0)]
dta <- data[(data$`Product: Category` == "ebook" & data$`Unit Price` == 0)]
View(dta)
data_1 <- data[data$`Order Id` == "Order 0239615"]
data_1 <- data[data$`Order Id` == "Order 0172425"]
data_1 <- data[data$`Order Id` == "Order 0213661"]
data_1 <- data[data$`Order Id` == "Order 0252642"]
#read in our data
data <- fread('./UNH_Membership_Project/project/volume/data/raw/raw_data.csv')
#removing records that won't be used for analysis
data <- distinct(data)
data <- data[data$`Account Record Type` == "Individual"]
data <- data[data$`Membership Category` == "Individual"]
data <- data[data$Status == "Active"]
data <- data[data$`Member Type` != "Individual Green Membership"]
data <- data[data$`Member Type` != "Press"]
data <- data[data$`Product: Record Type` != "Donation"]
data <- data[data$`Product: Record Type` != "Coupon"]
data <- data[!(data$`Product: Category` == "Book" & data$`Unit Price` == 0)]
data <- data[!(data$`Product: Category` == "ebook" & data$`Unit Price` == 0)]
#Converting date formats and specifying our date range
data$`Created Date`<- as.Date(data$`Created Date`, "%m/%d/%Y")
data$`Transaction Date` <- as.Date(data$`Transaction Date`, "%m/%d/%Y")
data <- data[data$`Transaction Date` < as.Date('2022-01-01')]
#removing columns that aren't important
remove <- c("OTP", "Designation", "Default Country", "Product: Short Name", "Account Safe Id",
"Account Safe Id-1", "Account Record Type-1", "Member-1", "Member Type-1", "Status",
"Person Account: Lead Source", "Certified", "Member")
data <- data[, remove:=NULL, with=FALSE]
#writing out our cleaned data
fwrite(data, './UNH_Membership_Project/project/volume/data/interim/cleaned_data.csv')
data <- fread('./UNH_Membership_Project/project/volume/data/intrim/cleaned_data.csv')
membership_list = c("Professional", "Not-For-Profit", "Government", "Higher Education", "Retired", "Transitional", "Student")
##########################################################################################################
#Direct membership
data_list <- data[(duplicated(data$`Order Id`) | duplicated(data$`Order Id`, fromLast = TRUE)) & data$`Unit Price` == 0]
#data$direct[data$`Product: Product Name` %in% direct_list & data$`Unit Price` > 0 & data$`Total Payment` >= data$`Unit Price`] <- 1
direct <- data[data$`Product: Product Name` %in% membership_list & data$`Unit Price` > 0 & data$`Total Payment` >= data$`Unit Price`]
#Get rid of records in data list
non_use = c(data_list$`Order Id`)
'%notin%' <- Negate('%in%')
Final_Direct <- direct[direct$`Order Id` %notin% non_use]
OTP_indirect <- data[(duplicated(data$`Order Id`) | duplicated(data$`Order Id`, fromLast = TRUE)) & data$`Unit Price` == 0 & data$`Total Payment` == 0]
Final_OTP <- OTP_indirect[OTP_indirect$`Product: Product Name` %in% membership_list]
#########################################################################################################
#Indirect Comp
comped1 <- data[data$`Product: Product Name` %in% membership_list & data$`Unit Price` > 0 & data$`Total Payment` == 0]
comped2 <- data[data$`Product: Product Name` %in% membership_list & data$`Unit Price` == 0 & data$`Total Payment` == 0 & !(duplicated(data$`Order Id`) | duplicated(data$`Order Id`, fromLast = TRUE))]
Final_Comp<- rbind(comped1, comped2)
bundle1 <- data[data$`Product: Product Name` %in% membership_list & (duplicated(data$`Order Id`) | duplicated(data$`Order Id`, fromLast = TRUE)) & data$`Unit Price` == 0 & data$`Total Payment` > 0]
bundle1[bundle1$`Order Id` == "Order 0637456"]
bundle2 <- data[data$`Product: Product Name` %in% membership_list & (duplicated(data$`Order Id`) | duplicated(data$`Order Id`, fromLast = TRUE)) & data$`Unit Price`> 0 & data$`Total Payment`> 0 & data$`Unit Price` <= data$`Total Payment`]
bundle2 <- bundle2[bundle2$`Order Id` %in% non_use]
Final_Bundle <- rbind(bundle1, bundle2)
Final_Bundle <- Final_Bundle[(!(duplicated(Final_Bundle$`Order Id`)))]
data3 <- data2[(duplicated(data2$`Order Id`) | duplicated(data2$`Order Id`, fromLast = TRUE))]
data3 <- Final_Direct[(duplicated(Final_Direct$`Order Id`) | duplicated(Final_Direct$`Order Id`, fromLast = TRUE))]
View(data3)
Final_Direct <- direct[direct$`Order Id` %notin% non_use]
Final_Direct <- Final_Direct[!(duplicated(Final_Direct$`Order Id`))]
View(Final_Direct)
data_4 <- data[data$`Unique ID` == "1459"]
View(data_4)
#Write out our final tables
fwrite(Final_Direct, './UNH_Membership_Project/project/volume/data/processed/Final_Direct.csv')
fwrite(Final_OTP, './UNH_Membership_Project/project/volume/data/processed/Final_OTP.csv')
fwrite(Final_Comp, './UNH_Membership_Project/project/volume/data/processed/Final_Comp.csv')
fwrite(Final_Bundle, './UNH_Membership_Project/project/volume/data/processed/Final_Bundle.csv')
Final_Direct <- fread('./UNH_Membership_Project/project/volume/data/processed/Final_Direct.csv')
Final_OTP <- fread('./UNH_Membership_Project/project/volume/data/processed/Final_OTP.csv')
Final_Comp <- fread('./UNH_Membership_Project/project/volume/data/processed/Final_Comp.csv')
Final_Bundle <- fread('./UNH_Membership_Project/project/volume/data/processed/Final_Bundle.csv')
Final_Bundle
Final_Direct$2016[Final_Direct$`Transaction Date`> as.Date('2016-01-01') & Final_Direct$`Transaction Date`< as.Date('2016-12-31')]
Final_Direct$2016[Final_Direct$`Transaction Date`> as.Date('2016-01-01') & Final_Direct$`Transaction Date`< as.Date('2016-12-31')] <- 1
Final_Direct$2016 <- 0
Final_Direct$2016 <- 0
View(Final_Direct)
library(data.table)
library(dplyr)
library(carat)
#read in our data
data <- fread('./UNH_Membership_Project/project/volume/data/raw/raw_data.csv')
#removing records that won't be used for analysis
data <- distinct(data)
data <- data[data$`Account Record Type` == "Individual"]
data <- data[data$`Membership Category` == "Individual"]
data <- data[data$Status == "Active"]
data <- data[data$`Member Type` != "Individual Green Membership"]
data <- data[data$`Member Type` != "Press"]
data <- data[data$`Product: Record Type` != "Donation"]
data <- data[data$`Product: Record Type` != "Coupon"]
data <- data[!(data$`Product: Category` == "Book" & data$`Unit Price` == 0)]
data <- data[!(data$`Product: Category` == "ebook" & data$`Unit Price` == 0)]
#Converting date formats and specifying our date range
data$`Created Date`<- as.Date(data$`Created Date`, "%m/%d/%Y")
data$`Transaction Date` <- as.Date(data$`Transaction Date`, "%m/%d/%Y")
data <- data[data$`Transaction Date` < as.Date('2022-01-01')]
#removing columns that aren't important
remove <- c("OTP", "Designation", "Default Country", "Product: Short Name", "Account Safe Id",
"Account Safe Id-1", "Account Record Type-1", "Member-1", "Member Type-1", "Status",
"Person Account: Lead Source", "Certified", "Member")
data <- data[, remove:=NULL, with=FALSE]
#writing out our cleaned data
fwrite(data, './UNH_Membership_Project/project/volume/data/interim/cleaned_data.csv')
data <- fread('./UNH_Membership_Project/project/volume/data/intrim/cleaned_data.csv')
membership_list = c("Professional", "Not-For-Profit", "Government", "Higher Education", "Retired", "Transitional", "Student")
##########################################################################################################
#Direct membership
data_list <- data[(duplicated(data$`Order Id`) | duplicated(data$`Order Id`, fromLast = TRUE)) & data$`Unit Price` == 0]
#data$direct[data$`Product: Product Name` %in% direct_list & data$`Unit Price` > 0 & data$`Total Payment` >= data$`Unit Price`] <- 1
direct <- data[data$`Product: Product Name` %in% membership_list & data$`Unit Price` > 0 & data$`Total Payment` >= data$`Unit Price`]
#Get rid of records in data list
non_use = c(data_list$`Order Id`)
'%notin%' <- Negate('%in%')
Final_Direct <- direct[direct$`Order Id` %notin% non_use]
Final_Direct <- Final_Direct[!(duplicated(Final_Direct$`Order Id`))]
OTP_indirect <- data[(duplicated(data$`Order Id`) | duplicated(data$`Order Id`, fromLast = TRUE)) & data$`Unit Price` == 0 & data$`Total Payment` == 0]
Final_OTP <- OTP_indirect[OTP_indirect$`Product: Product Name` %in% membership_list]
#########################################################################################################
#Indirect Comp
comped1 <- data[data$`Product: Product Name` %in% membership_list & data$`Unit Price` > 0 & data$`Total Payment` == 0]
comped2 <- data[data$`Product: Product Name` %in% membership_list & data$`Unit Price` == 0 & data$`Total Payment` == 0 & !(duplicated(data$`Order Id`) | duplicated(data$`Order Id`, fromLast = TRUE))]
Final_Comp<- rbind(comped1, comped2)
bundle1 <- data[data$`Product: Product Name` %in% membership_list & (duplicated(data$`Order Id`) | duplicated(data$`Order Id`, fromLast = TRUE)) & data$`Unit Price` == 0 & data$`Total Payment` > 0]
bundle1[bundle1$`Order Id` == "Order 0637456"]
bundle2 <- data[data$`Product: Product Name` %in% membership_list & (duplicated(data$`Order Id`) | duplicated(data$`Order Id`, fromLast = TRUE)) & data$`Unit Price`> 0 & data$`Total Payment`> 0 & data$`Unit Price` <= data$`Total Payment`]
bundle2 <- bundle2[bundle2$`Order Id` %in% non_use]
Final_Bundle <- rbind(bundle1, bundle2)
Final_Bundle <- Final_Bundle[(!(duplicated(Final_Bundle$`Order Id`)))]
#Write out our final tables
fwrite(Final_Direct, './UNH_Membership_Project/project/volume/data/processed/Final_Direct.csv')
fwrite(Final_OTP, './UNH_Membership_Project/project/volume/data/processed/Final_OTP.csv')
fwrite(Final_Comp, './UNH_Membership_Project/project/volume/data/processed/Final_Comp.csv')
fwrite(Final_Bundle, './UNH_Membership_Project/project/volume/data/processed/Final_Bundle.csv')
Final_Direct <- fread('./UNH_Membership_Project/project/volume/data/processed/Final_Direct.csv')
Final_OTP <- fread('./UNH_Membership_Project/project/volume/data/processed/Final_OTP.csv')
Final_Comp <- fread('./UNH_Membership_Project/project/volume/data/processed/Final_Comp.csv')
Final_Bundle <- fread('./UNH_Membership_Project/project/volume/data/processed/Final_Bundle.csv')
Final_Direct$2016 <- 0
View(Final_Direct)
Final_Direct <- fread('./UNH_Membership_Project/project/volume/data/processed/Final_Direct.csv')
View(Final_Direct)
#read in our data
data <- fread('./UNH_Membership_Project/project/volume/data/raw/raw_data.csv')
#removing records that won't be used for analysis
data <- distinct(data)
data <- data[data$`Account Record Type` == "Individual"]
data <- data[data$`Membership Category` == "Individual"]
data <- data[data$Status == "Active"]
data <- data[data$`Member Type` != "Individual Green Membership"]
data <- data[data$`Member Type` != "Press"]
data <- data[data$`Product: Record Type` != "Donation"]
data <- data[data$`Product: Record Type` != "Coupon"]
data <- data[!(data$`Product: Category` == "Book" & data$`Unit Price` == 0)]
data <- data[!(data$`Product: Category` == "ebook" & data$`Unit Price` == 0)]
#Converting date formats and specifying our date range
data$`Created Date`<- as.Date(data$`Created Date`, "%m/%d/%Y")
data$`Transaction Date` <- as.Date(data$`Transaction Date`, "%m/%d/%Y")
data <- data[data$`Transaction Date` < as.Date('2022-01-01')]
#removing columns that aren't important
remove <- c("OTP", "Designation", "Default Country", "Product: Short Name", "Account Safe Id",
"Account Safe Id-1", "Account Record Type-1", "Member-1", "Member Type-1", "Status",
"Person Account: Lead Source", "Certified", "Member", "Product: Category")
data <- data[, remove:=NULL, with=FALSE]
#writing out our cleaned data
fwrite(data, './UNH_Membership_Project/project/volume/data/interim/cleaned_data.csv')
#Direct vs Indirect Memberships
data <- fread('./UNH_Membership_Project/project/volume/data/intrim/cleaned_data.csv')
membership_list = c("Professional", "Not-For-Profit", "Government", "Higher Education", "Retired", "Transitional", "Student")
##########################################################################################################
#Direct membership
data_list <- data[(duplicated(data$`Order Id`) | duplicated(data$`Order Id`, fromLast = TRUE)) & data$`Unit Price` == 0]
#data$direct[data$`Product: Product Name` %in% direct_list & data$`Unit Price` > 0 & data$`Total Payment` >= data$`Unit Price`] <- 1
direct <- data[data$`Product: Product Name` %in% membership_list & data$`Unit Price` > 0 & data$`Total Payment` >= data$`Unit Price`]
#Get rid of records in data list
non_use = c(data_list$`Order Id`)
'%notin%' <- Negate('%in%')
Final_Direct <- direct[direct$`Order Id` %notin% non_use]
Final_Direct <- Final_Direct[!(duplicated(Final_Direct$`Order Id`))]
##########################################################################################################
#Indirect OTP
#data$OTP_indirect[duplicated(data$`Order Id`) & data$`Unit Price` == 0 & data$`Total Payment` == 0] <- 1
OTP_indirect <- data[(duplicated(data$`Order Id`) | duplicated(data$`Order Id`, fromLast = TRUE)) & data$`Unit Price` == 0 & data$`Total Payment` == 0]
Final_OTP <- OTP_indirect[OTP_indirect$`Product: Product Name` %in% membership_list]
#########################################################################################################
#Indirect Comp
comped1 <- data[data$`Product: Product Name` %in% membership_list & data$`Unit Price` > 0 & data$`Total Payment` == 0]
comped2 <- data[data$`Product: Product Name` %in% membership_list & data$`Unit Price` == 0 & data$`Total Payment` == 0 & !(duplicated(data$`Order Id`) | duplicated(data$`Order Id`, fromLast = TRUE))]
Final_Comp<- rbind(comped1, comped2)
#########################################################################################################
#Indirect Bundle
bundle1 <- data[data$`Product: Product Name` %in% membership_list & (duplicated(data$`Order Id`) | duplicated(data$`Order Id`, fromLast = TRUE)) & data$`Unit Price` == 0 & data$`Total Payment` > 0]
bundle1[bundle1$`Order Id` == "Order 0637456"]
bundle2 <- data[data$`Product: Product Name` %in% membership_list & (duplicated(data$`Order Id`) | duplicated(data$`Order Id`, fromLast = TRUE)) & data$`Unit Price`> 0 & data$`Total Payment`> 0 & data$`Unit Price` <= data$`Total Payment`]
bundle2 <- bundle2[bundle2$`Order Id` %in% non_use]
Final_Bundle <- rbind(bundle1, bundle2)
Final_Bundle <- Final_Bundle[(!(duplicated(Final_Bundle$`Order Id`)))]
#Write out our final tables
fwrite(Final_Direct, './UNH_Membership_Project/project/volume/data/processed/Final_Direct.csv')
fwrite(Final_OTP, './UNH_Membership_Project/project/volume/data/processed/Final_OTP.csv')
fwrite(Final_Comp, './UNH_Membership_Project/project/volume/data/processed/Final_Comp.csv')
fwrite(Final_Bundle, './UNH_Membership_Project/project/volume/data/processed/Final_Bundle.csv')
Final_Direct <- fread('./UNH_Membership_Project/project/volume/data/processed/Final_Direct.csv')
Final_OTP <- fread('./UNH_Membership_Project/project/volume/data/processed/Final_OTP.csv')
Final_Comp <- fread('./UNH_Membership_Project/project/volume/data/processed/Final_Comp.csv')
Final_Bundle <- fread('./UNH_Membership_Project/project/volume/data/processed/Final_Bundle.csv')
View(Final_Direct)
Final_Direct$2016 <- 0
Final_Direct$'2016' <- 0
View(Final_Direct)
Final_Direct$'2016'[Final_Direct$`Transaction Date`> as.Date('2016-01-01') & Final_Direct$`Transaction Date`< as.Date('2016-12-31')] <- 1
View(Final_Direct)
View(Final_Direct)
View(Final_Direct)
Direct_yearly$AccountID <- Final_Direct$`Unique ID`
Direct_yearly$AccountID <- Final_Direct[Final_Direct$`Unique ID`]
Direct_yearly <- Final_Direct[Final_Direct$`Unique ID`]
View(Direct_yearly)
Final_Direct <- fread('./UNH_Membership_Project/project/volume/data/processed/Final_Direct.csv')
Final_OTP <- fread('./UNH_Membership_Project/project/volume/data/processed/Final_OTP.csv')
Final_Comp <- fread('./UNH_Membership_Project/project/volume/data/processed/Final_Comp.csv')
Final_Bundle <- fread('./UNH_Membership_Project/project/volume/data/processed/Final_Bundle.csv')
Direct_yearly <- Final_Direct[Final_Direct$`Unique ID`]
View(Direct_yearly)
Direct_yearly <- Final_Direct[Final_Direct$`Unit Price`]
View(Direct_yearly)
Direct_yearly <- Final_Direct$`Unique ID`
Direct_yearly$'2016'[Final_Direct$`Transaction Date`> as.Date('2016-01-01') & Final_Direct$`Transaction Date`< as.Date('2016-12-31')] <- 1
View(Final_Direct)
Direct_yearly <- fread(Final_Direct$`Unique ID`)
Direct_yearly <- fread(Direct_yearly)
Direct_yearly = Final_Direct$`Unique ID`
Direct_yearly <- fread(Direct_yearly)
Direct_yearly = melt(Final_Direct, id.vars = c("Unique ID"), measure.vars = c("2016", "2017", "2018", "2019", "2020", "2021"))
Final_Direct$'2016'[Final_Direct$`Transaction Date`> as.Date('2016-01-01') & Final_Direct$`Transaction Date`< as.Date('2016-12-31')] <- 1
Final_Direct$'2017'[Final_Direct$`Transaction Date`> as.Date('2017-01-01') & Final_Direct$`Transaction Date`< as.Date('2017-12-31')] <- 1
Final_Direct$'2018'[Final_Direct$`Transaction Date`> as.Date('2018-01-01') & Final_Direct$`Transaction Date`< as.Date('2018-12-31')] <- 1
Final_Direct$'2019'[Final_Direct$`Transaction Date`> as.Date('2019-01-01') & Final_Direct$`Transaction Date`< as.Date('2019-12-31')] <- 1
Final_Direct$'2020'[Final_Direct$`Transaction Date`> as.Date('2020-01-01') & Final_Direct$`Transaction Date`< as.Date('2020-12-31')] <- 1
Final_Direct$'2021'[Final_Direct$`Transaction Date`> as.Date('2021-01-01') & Final_Direct$`Transaction Date`< as.Date('2021-12-31')] <- 1
Direct_yearly = melt(Final_Direct, id.vars = c("Unique ID"), measure.vars = c("2016", "2017", "2018", "2019", "2020", "2021"))
View(Direct_yearly)
Direct_yearly = melt(Final_Direct, id.vars = c("2016", "2017", "2018", "2019", "2020", "2021"), measure.vars = c("Unique ID"))
View(Direct_yearly)
Direct_yearly = melt(Final_Direct, id.vars = c("2016", "2017", "2018", "2019", "2020", "2021"))
Direct_yearly = melt(Final_Direct,measure.vars = "Unique ID", id.vars = c("2016", "2017", "2018", "2019", "2020", "2021"), value.name = "Account ID")
View(Direct_yearly)
Direct_yearly = melt(Final_Direct,measure.vars = "Unique ID", id.vars = c("2016", "2017", "2018", "2019", "2020", "2021"), value.name = "Account ID", is.na = FALSE)
View(Direct_yearly)
Direct_yearly = melt(Final_Direct,measure.vars = "Unique ID", id.vars = c("2016", "2017", "2018", "2019", "2020", "2021"), value.name = "Account ID")
View(Direct_yearly)
Direct_yearly = dcast(Final_Direct, `Unique ID` ~ ., value.var = "2016", "2017")
Direct_yearly = dcast(Final_Direct, `Unique ID` ~ ., value.var = c("2016", "2017"))
Direct_yearly = dcast(Final_Direct, `Unique ID` ~ variable, value.var = c("2016", "2017"))
Direct_yearly = dcast(Final_Direct, `Unique ID` ~ ., value.var = c("2016", "2017"))
Final_Direct$year[Final_Direct$`Transaction Date`> as.Date('2016-01-01') & Final_Direct$`Transaction Date`< as.Date('2016-12-31')] <- "2016"
Final_Direct$year[Final_Direct$`Transaction Date`> as.Date('2017-01-01') & Final_Direct$`Transaction Date`< as.Date('2017-12-31')] <- "2017"
Final_Direct$year[Final_Direct$`Transaction Date`> as.Date('2018-01-01') & Final_Direct$`Transaction Date`< as.Date('2018-12-31')] <- "2018"
Final_Direct$year[Final_Direct$`Transaction Date`> as.Date('2019-01-01') & Final_Direct$`Transaction Date`< as.Date('2019-12-31')] <- "2019"
Final_Direct$year[Final_Direct$`Transaction Date`> as.Date('2020-01-01') & Final_Direct$`Transaction Date`< as.Date('2020-12-31')] <- "2020"
Final_Direct$year[Final_Direct$`Transaction Date`> as.Date('2021-01-01') & Final_Direct$`Transaction Date`< as.Date('2021-12-31')] <- "2021"
Final_Direct <- fread('./UNH_Membership_Project/project/volume/data/processed/Final_Direct.csv')
Final_OTP <- fread('./UNH_Membership_Project/project/volume/data/processed/Final_OTP.csv')
Final_Comp <- fread('./UNH_Membership_Project/project/volume/data/processed/Final_Comp.csv')
Final_Bundle <- fread('./UNH_Membership_Project/project/volume/data/processed/Final_Bundle.csv')
Final_Direct$year[Final_Direct$`Transaction Date`> as.Date('2016-01-01') & Final_Direct$`Transaction Date`< as.Date('2016-12-31')] <- "2016"
Final_Direct$year[Final_Direct$`Transaction Date`> as.Date('2017-01-01') & Final_Direct$`Transaction Date`< as.Date('2017-12-31')] <- "2017"
Final_Direct$year[Final_Direct$`Transaction Date`> as.Date('2018-01-01') & Final_Direct$`Transaction Date`< as.Date('2018-12-31')] <- "2018"
Final_Direct$year[Final_Direct$`Transaction Date`> as.Date('2019-01-01') & Final_Direct$`Transaction Date`< as.Date('2019-12-31')] <- "2019"
Final_Direct$year[Final_Direct$`Transaction Date`> as.Date('2020-01-01') & Final_Direct$`Transaction Date`< as.Date('2020-12-31')] <- "2020"
Final_Direct$year[Final_Direct$`Transaction Date`> as.Date('2021-01-01') & Final_Direct$`Transaction Date`< as.Date('2021-12-31')] <- "2021"
Direct_yearly = dcast(Final_Direct, `Unique ID` ~ year)
View(Direct_yearly)
distinct(Final_Direct)
Final_Direct[(!(duplicated(Final_Bundle$`Unique ID`)))]
dtaaa <- [(!(duplicated(Final_Bundle$`Unique ID`)))]
dtaaa <- Final_Direct[(!(duplicated(Final_Direct$`Unique ID`)))]
Direct_yearly = dcast(Final_Direct, `Unique ID` ~ year)
data_4 <- data[data$`Unique ID` == "321278"]
View(data_4)
Final_Direct <- fread('./UNH_Membership_Project/project/volume/data/processed/Final_Direct.csv')
Final_OTP <- fread('./UNH_Membership_Project/project/volume/data/processed/Final_OTP.csv')
Final_Comp <- fread('./UNH_Membership_Project/project/volume/data/processed/Final_Comp.csv')
Final_Bundle <- fread('./UNH_Membership_Project/project/volume/data/processed/Final_Bundle.csv')
Final_Direct$year[Final_Direct$`Transaction Date` >= as.Date('2016-01-01') & Final_Direct$`Transaction Date` <= as.Date('2016-12-31')] <- "2016"
Final_Direct$year[Final_Direct$`Transaction Date` >= as.Date('2017-01-01') & Final_Direct$`Transaction Date` <= as.Date('2017-12-31')] <- "2017"
Final_Direct$year[Final_Direct$`Transaction Date` >= as.Date('2018-01-01') & Final_Direct$`Transaction Date` <= as.Date('2018-12-31')] <- "2018"
Final_Direct$year[Final_Direct$`Transaction Date` >= as.Date('2019-01-01') & Final_Direct$`Transaction Date` <= as.Date('2019-12-31')] <- "2019"
Final_Direct$year[Final_Direct$`Transaction Date` >= as.Date('2020-01-01') & Final_Direct$`Transaction Date` <= as.Date('2020-12-31')] <- "2020"
Final_Direct$year[Final_Direct$`Transaction Date` >= as.Date('2021-01-01') & Final_Direct$`Transaction Date` <= as.Date('2021-12-31')] <- "2021"
Direct_yearly = dcast(Final_Direct, `Unique ID` ~ year)
data_4 <- data[data$`Unique ID` == "280188"]
View(data_4)
