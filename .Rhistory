Final_Bundle <- fread('./UNH_Membership_Project/project/volume/data/processed/Final_Bundle.csv')
Final_Direct$num <- 1
Final_OTP$num <- 2
Final_Comp$num <- 3
Final_Bundle$num <- 4
merged <- bind_rows(Final_Direct, Final_OTP, Final_Comp, Final_Bundle)
merged <- setorder(merged, cols = `Order Id`)
merged <- merged[setorder(merged, cols = `Order Id`)]
setorder(merged, cols = `Order Id`)
merged
merged <- as.data.frame(merged)
Final_Direct <- fread('./UNH_Membership_Project/project/volume/data/processed/Final_Direct.csv')
Final_OTP <- fread('./UNH_Membership_Project/project/volume/data/processed/Final_OTP.csv')
Final_Comp <- fread('./UNH_Membership_Project/project/volume/data/processed/Final_Comp.csv')
Final_Bundle <- fread('./UNH_Membership_Project/project/volume/data/processed/Final_Bundle.csv')
Final_Direct$num <- 1
Final_OTP$num <- 2
Final_Comp$num <- 3
Final_Bundle$num <- 4
#Adding year of transaction to Final_Direct
Final_Direct$year[Final_Direct$`Transaction Date` >= as.Date('2016-01-01') & Final_Direct$`Transaction Date` <= as.Date('2016-12-31')] <- "2016"
Final_Direct$year[Final_Direct$`Transaction Date` >= as.Date('2017-01-01') & Final_Direct$`Transaction Date` <= as.Date('2017-12-31')] <- "2017"
Final_Direct$year[Final_Direct$`Transaction Date` >= as.Date('2018-01-01') & Final_Direct$`Transaction Date` <= as.Date('2018-12-31')] <- "2018"
Final_Direct$year[Final_Direct$`Transaction Date` >= as.Date('2019-01-01') & Final_Direct$`Transaction Date` <= as.Date('2019-12-31')] <- "2019"
Final_Direct$year[Final_Direct$`Transaction Date` >= as.Date('2020-01-01') & Final_Direct$`Transaction Date` <= as.Date('2020-12-31')] <- "2020"
Final_Direct$year[Final_Direct$`Transaction Date` >= as.Date('2021-01-01') & Final_Direct$`Transaction Date` <= as.Date('2021-12-31')] <- "2021"
#Adding year of transaction to Final_OTP
Final_OTP$year[Final_OTP$`Transaction Date` >= as.Date('2016-01-01') & Final_OTP$`Transaction Date` <= as.Date('2016-12-31')] <- "2016"
Final_OTP$year[Final_OTP$`Transaction Date` >= as.Date('2017-01-01') & Final_OTP$`Transaction Date` <= as.Date('2017-12-31')] <- "2017"
Final_OTP$year[Final_OTP$`Transaction Date` >= as.Date('2018-01-01') & Final_OTP$`Transaction Date` <= as.Date('2018-12-31')] <- "2018"
Final_OTP$year[Final_OTP$`Transaction Date` >= as.Date('2019-01-01') & Final_OTP$`Transaction Date` <= as.Date('2019-12-31')] <- "2019"
Final_OTP$year[Final_OTP$`Transaction Date` >= as.Date('2020-01-01') & Final_OTP$`Transaction Date` <= as.Date('2020-12-31')] <- "2020"
Final_OTP$year[Final_OTP$`Transaction Date` >= as.Date('2021-01-01') & Final_OTP$`Transaction Date` <= as.Date('2021-12-31')] <- "2021"
#Adding year of transaction to Final_Comp
Final_Comp$year[Final_Comp$`Transaction Date` >= as.Date('2016-01-01') & Final_Comp$`Transaction Date` <= as.Date('2016-12-31')] <- "2016"
Final_Comp$year[Final_Comp$`Transaction Date` >= as.Date('2017-01-01') & Final_Comp$`Transaction Date` <= as.Date('2017-12-31')] <- "2017"
Final_Comp$year[Final_Comp$`Transaction Date` >= as.Date('2018-01-01') & Final_Comp$`Transaction Date` <= as.Date('2018-12-31')] <- "2018"
Final_Comp$year[Final_Comp$`Transaction Date` >= as.Date('2019-01-01') & Final_Comp$`Transaction Date` <= as.Date('2019-12-31')] <- "2019"
Final_Comp$year[Final_Comp$`Transaction Date` >= as.Date('2020-01-01') & Final_Comp$`Transaction Date` <= as.Date('2020-12-31')] <- "2020"
Final_Comp$year[Final_Comp$`Transaction Date` >= as.Date('2021-01-01') & Final_Comp$`Transaction Date` <= as.Date('2021-12-31')] <- "2021"
#Adding year of transaction to Final_Bundle
Final_Bundle$year[Final_Bundle$`Transaction Date` >= as.Date('2016-01-01') & Final_Bundle$`Transaction Date` <= as.Date('2016-12-31')] <- "2016"
Final_Bundle$year[Final_Bundle$`Transaction Date` >= as.Date('2017-01-01') & Final_Bundle$`Transaction Date` <= as.Date('2017-12-31')] <- "2017"
Final_Bundle$year[Final_Bundle$`Transaction Date` >= as.Date('2018-01-01') & Final_Bundle$`Transaction Date` <= as.Date('2018-12-31')] <- "2018"
Final_Bundle$year[Final_Bundle$`Transaction Date` >= as.Date('2019-01-01') & Final_Bundle$`Transaction Date` <= as.Date('2019-12-31')] <- "2019"
Final_Bundle$year[Final_Bundle$`Transaction Date` >= as.Date('2020-01-01') & Final_Bundle$`Transaction Date` <= as.Date('2020-12-31')] <- "2020"
Final_Bundle$year[Final_Bundle$`Transaction Date` >= as.Date('2021-01-01') & Final_Bundle$`Transaction Date` <= as.Date('2021-12-31')] <- "2021"
merged <- bind_rows(Final_Direct, Final_OTP, Final_Comp, Final_Bundle)
setorder(merged, cols = `Order Id`)
merged <- as.data.frame(merged)
merged <- merged[!duplicated(merged[c('Unique ID', 'year')]),]
merged <- as.data.table(merged)
Final_Direct <- fread('./UNH_Membership_Project/project/volume/data/processed/Final_Direct.csv')
Final_OTP <- fread('./UNH_Membership_Project/project/volume/data/processed/Final_OTP.csv')
Final_Comp <- fread('./UNH_Membership_Project/project/volume/data/processed/Final_Comp.csv')
Final_Bundle <- fread('./UNH_Membership_Project/project/volume/data/processed/Final_Bundle.csv')
Final_Direct$num <- 1
Final_OTP$num <- 2
Final_Comp$num <- 3
Final_Bundle$num <- 4
#Adding year of transaction to Final_Direct
Final_Direct$year[Final_Direct$`Transaction Date` >= as.Date('2016-01-01') & Final_Direct$`Transaction Date` <= as.Date('2016-12-31')] <- "2016"
Final_Direct$year[Final_Direct$`Transaction Date` >= as.Date('2017-01-01') & Final_Direct$`Transaction Date` <= as.Date('2017-12-31')] <- "2017"
Final_Direct$year[Final_Direct$`Transaction Date` >= as.Date('2018-01-01') & Final_Direct$`Transaction Date` <= as.Date('2018-12-31')] <- "2018"
Final_Direct$year[Final_Direct$`Transaction Date` >= as.Date('2019-01-01') & Final_Direct$`Transaction Date` <= as.Date('2019-12-31')] <- "2019"
Final_Direct$year[Final_Direct$`Transaction Date` >= as.Date('2020-01-01') & Final_Direct$`Transaction Date` <= as.Date('2020-12-31')] <- "2020"
Final_Direct$year[Final_Direct$`Transaction Date` >= as.Date('2021-01-01') & Final_Direct$`Transaction Date` <= as.Date('2021-12-31')] <- "2021"
#Adding year of transaction to Final_OTP
Final_OTP$year[Final_OTP$`Transaction Date` >= as.Date('2016-01-01') & Final_OTP$`Transaction Date` <= as.Date('2016-12-31')] <- "2016"
Final_OTP$year[Final_OTP$`Transaction Date` >= as.Date('2017-01-01') & Final_OTP$`Transaction Date` <= as.Date('2017-12-31')] <- "2017"
Final_OTP$year[Final_OTP$`Transaction Date` >= as.Date('2018-01-01') & Final_OTP$`Transaction Date` <= as.Date('2018-12-31')] <- "2018"
Final_OTP$year[Final_OTP$`Transaction Date` >= as.Date('2019-01-01') & Final_OTP$`Transaction Date` <= as.Date('2019-12-31')] <- "2019"
Final_OTP$year[Final_OTP$`Transaction Date` >= as.Date('2020-01-01') & Final_OTP$`Transaction Date` <= as.Date('2020-12-31')] <- "2020"
Final_OTP$year[Final_OTP$`Transaction Date` >= as.Date('2021-01-01') & Final_OTP$`Transaction Date` <= as.Date('2021-12-31')] <- "2021"
#Adding year of transaction to Final_Comp
Final_Comp$year[Final_Comp$`Transaction Date` >= as.Date('2016-01-01') & Final_Comp$`Transaction Date` <= as.Date('2016-12-31')] <- "2016"
Final_Comp$year[Final_Comp$`Transaction Date` >= as.Date('2017-01-01') & Final_Comp$`Transaction Date` <= as.Date('2017-12-31')] <- "2017"
Final_Comp$year[Final_Comp$`Transaction Date` >= as.Date('2018-01-01') & Final_Comp$`Transaction Date` <= as.Date('2018-12-31')] <- "2018"
Final_Comp$year[Final_Comp$`Transaction Date` >= as.Date('2019-01-01') & Final_Comp$`Transaction Date` <= as.Date('2019-12-31')] <- "2019"
Final_Comp$year[Final_Comp$`Transaction Date` >= as.Date('2020-01-01') & Final_Comp$`Transaction Date` <= as.Date('2020-12-31')] <- "2020"
Final_Comp$year[Final_Comp$`Transaction Date` >= as.Date('2021-01-01') & Final_Comp$`Transaction Date` <= as.Date('2021-12-31')] <- "2021"
#Adding year of transaction to Final_Bundle
Final_Bundle$year[Final_Bundle$`Transaction Date` >= as.Date('2016-01-01') & Final_Bundle$`Transaction Date` <= as.Date('2016-12-31')] <- "2016"
Final_Bundle$year[Final_Bundle$`Transaction Date` >= as.Date('2017-01-01') & Final_Bundle$`Transaction Date` <= as.Date('2017-12-31')] <- "2017"
Final_Bundle$year[Final_Bundle$`Transaction Date` >= as.Date('2018-01-01') & Final_Bundle$`Transaction Date` <= as.Date('2018-12-31')] <- "2018"
Final_Bundle$year[Final_Bundle$`Transaction Date` >= as.Date('2019-01-01') & Final_Bundle$`Transaction Date` <= as.Date('2019-12-31')] <- "2019"
Final_Bundle$year[Final_Bundle$`Transaction Date` >= as.Date('2020-01-01') & Final_Bundle$`Transaction Date` <= as.Date('2020-12-31')] <- "2020"
Final_Bundle$year[Final_Bundle$`Transaction Date` >= as.Date('2021-01-01') & Final_Bundle$`Transaction Date` <= as.Date('2021-12-31')] <- "2021"
merged <- bind_rows(Final_Direct, Final_OTP, Final_Comp, Final_Bundle)
setorder(merged, cols = `Order Id`)
merged <- as.data.frame(merged)
merged <- merged[!duplicated(merged[c('Unique ID', 'year')]),]
merged <- as.data.table(merged)
#Separate table back into Direct, OTP, Comp, or Bundle
Final_Direct <- merged[merged$num == 1]
Final_OTP <- merged[merged$num == 2]
Final_Comp <- merged[merged$num == 3]
Final_Bundle <- merged[merged$num == 4]
View(Final_Bundle)
Final_Direct <- Final_Direct[, 'num':=NULL]
Final_OTP <- Final_OTP[, 'num':=NULL]
Final_Comp <- Final_Comp[, 'num':=NULL]
Final_Bundle <- Final_Bundle[, 'num':=NULL]
##############
#Direct Yearly
Direct_yearly = dcast(Final_Direct, `Unique ID` ~ year)
Direct_yearly <- Direct_yearly[,"NA":=NULL]
for(j in 2:ncol(Direct_yearly)){
set(Direct_yearly, i= which(Direct_yearly[[j]]!=0), j=j, value =1)
}
###########
#OTP Yearly
OTP_yearly = dcast(Final_OTP, `Unique ID` ~ year)
OTP_yearly <- OTP_yearly[,"NA":=NULL]
for(j in 2:ncol(OTP_yearly)){
set(OTP_yearly, i= which(OTP_yearly[[j]]!=0), j=j, value =2)
}
Total_yearly<-rbind(Direct_yearly, OTP_yearly)
############
#Comp Yearly
Comp_yearly = dcast(Final_Comp, `Unique ID` ~ year)
Comp_yearly <- Comp_yearly[,"NA":=NULL]
for(j in 2:ncol(Comp_yearly)){
set(Comp_yearly, i= which(Comp_yearly[[j]]!=0), j=j, value =3)
}
Total_yearly<-rbind(Total_yearly, Comp_yearly)
##############
#Bundle Yearly
Bundle_yearly = dcast(Final_Bundle, `Unique ID` ~ year)
Bundle_yearly <- Bundle_yearly[,"NA":=NULL]
for(j in 2:ncol(Bundle_yearly)){
set(Bundle_yearly, i= which(Bundle_yearly[[j]]!=0), j=j, value =4)
}
Total_yearly<-rbind(Total_yearly, Bundle_yearly)
Total_yearly<-Total_yearly[,.(`2016`=sum(`2016`), `2017`=sum(`2017`), `2018`=sum(`2018`), `2019`=sum(`2019`), `2020`=sum(`2020`), `2021`=sum(`2021`)), `Unique ID`]
Final_Direct <- fread('./UNH_Membership_Project/project/volume/data/processed/Final_Direct.csv')
Final_OTP <- fread('./UNH_Membership_Project/project/volume/data/processed/Final_OTP.csv')
Final_Comp <- fread('./UNH_Membership_Project/project/volume/data/processed/Final_Comp.csv')
Final_Bundle <- fread('./UNH_Membership_Project/project/volume/data/processed/Final_Bundle.csv')
Final_Direct$num <- 1
Final_OTP$num <- 2
Final_Comp$num <- 3
Final_Bundle$num <- 4
#Adding year of transaction to Final_Direct
Final_Direct$year[Final_Direct$`Transaction Date` >= as.Date('2016-01-01') & Final_Direct$`Transaction Date` <= as.Date('2016-12-31')] <- "2016"
Final_Direct$year[Final_Direct$`Transaction Date` >= as.Date('2017-01-01') & Final_Direct$`Transaction Date` <= as.Date('2017-12-31')] <- "2017"
Final_Direct$year[Final_Direct$`Transaction Date` >= as.Date('2018-01-01') & Final_Direct$`Transaction Date` <= as.Date('2018-12-31')] <- "2018"
Final_Direct$year[Final_Direct$`Transaction Date` >= as.Date('2019-01-01') & Final_Direct$`Transaction Date` <= as.Date('2019-12-31')] <- "2019"
Final_Direct$year[Final_Direct$`Transaction Date` >= as.Date('2020-01-01') & Final_Direct$`Transaction Date` <= as.Date('2020-12-31')] <- "2020"
Final_Direct$year[Final_Direct$`Transaction Date` >= as.Date('2021-01-01') & Final_Direct$`Transaction Date` <= as.Date('2021-12-31')] <- "2021"
#Adding year of transaction to Final_OTP
Final_OTP$year[Final_OTP$`Transaction Date` >= as.Date('2016-01-01') & Final_OTP$`Transaction Date` <= as.Date('2016-12-31')] <- "2016"
Final_OTP$year[Final_OTP$`Transaction Date` >= as.Date('2017-01-01') & Final_OTP$`Transaction Date` <= as.Date('2017-12-31')] <- "2017"
Final_OTP$year[Final_OTP$`Transaction Date` >= as.Date('2018-01-01') & Final_OTP$`Transaction Date` <= as.Date('2018-12-31')] <- "2018"
Final_OTP$year[Final_OTP$`Transaction Date` >= as.Date('2019-01-01') & Final_OTP$`Transaction Date` <= as.Date('2019-12-31')] <- "2019"
Final_OTP$year[Final_OTP$`Transaction Date` >= as.Date('2020-01-01') & Final_OTP$`Transaction Date` <= as.Date('2020-12-31')] <- "2020"
Final_OTP$year[Final_OTP$`Transaction Date` >= as.Date('2021-01-01') & Final_OTP$`Transaction Date` <= as.Date('2021-12-31')] <- "2021"
#Adding year of transaction to Final_Comp
Final_Comp$year[Final_Comp$`Transaction Date` >= as.Date('2016-01-01') & Final_Comp$`Transaction Date` <= as.Date('2016-12-31')] <- "2016"
Final_Comp$year[Final_Comp$`Transaction Date` >= as.Date('2017-01-01') & Final_Comp$`Transaction Date` <= as.Date('2017-12-31')] <- "2017"
Final_Comp$year[Final_Comp$`Transaction Date` >= as.Date('2018-01-01') & Final_Comp$`Transaction Date` <= as.Date('2018-12-31')] <- "2018"
Final_Comp$year[Final_Comp$`Transaction Date` >= as.Date('2019-01-01') & Final_Comp$`Transaction Date` <= as.Date('2019-12-31')] <- "2019"
Final_Comp$year[Final_Comp$`Transaction Date` >= as.Date('2020-01-01') & Final_Comp$`Transaction Date` <= as.Date('2020-12-31')] <- "2020"
Final_Comp$year[Final_Comp$`Transaction Date` >= as.Date('2021-01-01') & Final_Comp$`Transaction Date` <= as.Date('2021-12-31')] <- "2021"
#Adding year of transaction to Final_Bundle
Final_Bundle$year[Final_Bundle$`Transaction Date` >= as.Date('2016-01-01') & Final_Bundle$`Transaction Date` <= as.Date('2016-12-31')] <- "2016"
Final_Bundle$year[Final_Bundle$`Transaction Date` >= as.Date('2017-01-01') & Final_Bundle$`Transaction Date` <= as.Date('2017-12-31')] <- "2017"
Final_Bundle$year[Final_Bundle$`Transaction Date` >= as.Date('2018-01-01') & Final_Bundle$`Transaction Date` <= as.Date('2018-12-31')] <- "2018"
Final_Bundle$year[Final_Bundle$`Transaction Date` >= as.Date('2019-01-01') & Final_Bundle$`Transaction Date` <= as.Date('2019-12-31')] <- "2019"
Final_Bundle$year[Final_Bundle$`Transaction Date` >= as.Date('2020-01-01') & Final_Bundle$`Transaction Date` <= as.Date('2020-12-31')] <- "2020"
Final_Bundle$year[Final_Bundle$`Transaction Date` >= as.Date('2021-01-01') & Final_Bundle$`Transaction Date` <= as.Date('2021-12-31')] <- "2021"
merged <- bind_rows(Final_Direct, Final_OTP, Final_Comp, Final_Bundle)
setorder(merged, cols = `Order Id`)
merged <- as.data.frame(merged)
merged <- merged[!duplicated(merged[c('Unique ID', 'year')]),]
merged <- as.data.table(merged)
#Separate table back into Direct, OTP, Comp, or Bundle
Final_Direct <- merged[merged$num == 1]
Final_OTP <- merged[merged$num == 2]
Final_Comp <- merged[merged$num == 3]
Final_Bundle <- merged[merged$num == 4]
Final_Direct <- Final_Direct[, 'num':=NULL]
Final_OTP <- Final_OTP[, 'num':=NULL]
Final_Comp <- Final_Comp[, 'num':=NULL]
Final_Bundle <- Final_Bundle[, 'num':=NULL]
##############
#Direct Yearly
Direct_yearly = dcast(Final_Direct, `Unique ID` ~ year)
Direct_yearly <- Direct_yearly[,"NA":=NULL]
for(j in 2:ncol(Direct_yearly)){
set(Direct_yearly, i= which(Direct_yearly[[j]]!=0), j=j, value =1)
}
###########
#OTP Yearly
OTP_yearly = dcast(Final_OTP, `Unique ID` ~ year)
OTP_yearly <- OTP_yearly[,"NA":=NULL]
for(j in 2:ncol(OTP_yearly)){
set(OTP_yearly, i= which(OTP_yearly[[j]]!=0), j=j, value =2)
}
Total_yearly<-rbind(Direct_yearly, OTP_yearly)
############
#Comp Yearly
Comp_yearly = dcast(Final_Comp, `Unique ID` ~ year)
Comp_yearly <- Comp_yearly[,"NA":=NULL]
for(j in 2:ncol(Comp_yearly)){
set(Comp_yearly, i= which(Comp_yearly[[j]]!=0), j=j, value =3)
}
Total_yearly<-rbind(Total_yearly, Comp_yearly)
##############
#Bundle Yearly
Bundle_yearly = dcast(Final_Bundle, `Unique ID` ~ year)
Bundle_yearly <- Bundle_yearly[,"NA":=NULL]
for(j in 2:ncol(Bundle_yearly)){
set(Bundle_yearly, i= which(Bundle_yearly[[j]]!=0), j=j, value =4)
}
Total_yearly<-rbind(Total_yearly, Bundle_yearly)
Total_yearly[is.na(Total_yearly)] <- 0
Total_yearly <- Total_yearly[,.(`2016`=sum(`2016`), `2017`=sum(`2017`), `2018`=sum(`2018`), `2019`=sum(`2019`), `2020`=sum(`2020`), `2021`=sum(`2021`)), `Unique ID`]
data_4 <- data[data$`Unique ID` == "340858"]
View(data_4)
str(Total_yearly)
library(data.table)
library(dplyr)
library(carat)
#read in our data
data <- fread('./UNH_Membership_Project/project/volume/data/raw/raw_data.csv')
#removing records that won't be used for analysis
data <- distinct(data)
data <- data[data$`Account Record Type` == "Individual"]
data <- data[data$`Membership Category` == "Individual"]
data <- data[data$Status == "Active"]
data <- data[data$`Member Type` != "Individual Green Membership"]
data <- data[data$`Member Type` != "Press"]
data <- data[data$`Product: Record Type` != "Donation"]
data <- data[data$`Product: Record Type` != "Coupon"]
data <- data[!(data$`Product: Category` == "Book" & data$`Unit Price` == 0)]
data <- data[!(data$`Product: Category` == "ebook" & data$`Unit Price` == 0)]
#Converting date formats and specifying our date range
data$`Created Date`<- as.Date(data$`Created Date`, "%m/%d/%Y")
data$`Transaction Date` <- as.Date(data$`Transaction Date`, "%m/%d/%Y")
data <- data[data$`Transaction Date` < as.Date('2022-01-01')]
#removing columns that aren't important
remove <- c("OTP", "Designation", "Default Country", "Product: Short Name", "Account Safe Id",
"Account Safe Id-1", "Account Record Type-1", "Member-1", "Member Type-1", "Status",
"Person Account: Lead Source", "Certified", "Member", "Product: Category")
data <- data[, remove:=NULL, with=FALSE]
#writing out our cleaned data
fwrite(data, './UNH_Membership_Project/project/volume/data/interim/cleaned_data.csv')
#Direct vs Indirect Memberships
data <- fread('./UNH_Membership_Project/project/volume/data/intrim/cleaned_data.csv')
membership_list = c("Professional", "Not-For-Profit", "Government", "Higher Education", "Retired", "Transitional", "Student")
##########################################################################################################
#Direct membership
data_list <- data[(duplicated(data$`Order Id`) | duplicated(data$`Order Id`, fromLast = TRUE)) & data$`Unit Price` == 0]
#data$direct[data$`Product: Product Name` %in% direct_list & data$`Unit Price` > 0 & data$`Total Payment` >= data$`Unit Price`] <- 1
direct <- data[data$`Product: Product Name` %in% membership_list & data$`Unit Price` > 0 & data$`Total Payment` >= data$`Unit Price`]
#Get rid of records in data list
non_use = c(data_list$`Order Id`)
'%notin%' <- Negate('%in%')
Final_Direct <- direct[direct$`Order Id` %notin% non_use]
Final_Direct <- Final_Direct[!(duplicated(Final_Direct$`Order Id`))]
##########################################################################################################
#Indirect OTP
#data$OTP_indirect[duplicated(data$`Order Id`) & data$`Unit Price` == 0 & data$`Total Payment` == 0] <- 1
OTP_indirect <- data[(duplicated(data$`Order Id`) | duplicated(data$`Order Id`, fromLast = TRUE)) & data$`Unit Price` == 0 & data$`Total Payment` == 0]
Final_OTP <- OTP_indirect[OTP_indirect$`Product: Product Name` %in% membership_list]
#########################################################################################################
#Indirect Comp
comped1 <- data[data$`Product: Product Name` %in% membership_list & data$`Unit Price` > 0 & data$`Total Payment` == 0]
comped2 <- data[data$`Product: Product Name` %in% membership_list & data$`Unit Price` == 0 & data$`Total Payment` == 0 & !(duplicated(data$`Order Id`) | duplicated(data$`Order Id`, fromLast = TRUE))]
Final_Comp<- rbind(comped1, comped2)
#########################################################################################################
#Indirect Bundle
bundle1 <- data[data$`Product: Product Name` %in% membership_list & (duplicated(data$`Order Id`) | duplicated(data$`Order Id`, fromLast = TRUE)) & data$`Unit Price` == 0 & data$`Total Payment` > 0]
bundle2 <- data[data$`Product: Product Name` %in% membership_list & (duplicated(data$`Order Id`) | duplicated(data$`Order Id`, fromLast = TRUE)) & data$`Unit Price`> 0 & data$`Total Payment`> 0 & data$`Unit Price` <= data$`Total Payment`]
bundle2 <- bundle2[bundle2$`Order Id` %in% non_use]
Final_Bundle <- rbind(bundle1, bundle2)
Final_Bundle <- Final_Bundle[(!(duplicated(Final_Bundle$`Order Id`)))]
#Write out our final tables
fwrite(Final_Direct, './UNH_Membership_Project/project/volume/data/processed/Final_Direct.csv')
fwrite(Final_OTP, './UNH_Membership_Project/project/volume/data/processed/Final_OTP.csv')
fwrite(Final_Comp, './UNH_Membership_Project/project/volume/data/processed/Final_Comp.csv')
fwrite(Final_Bundle, './UNH_Membership_Project/project/volume/data/processed/Final_Bundle.csv')
Final_Direct <- fread('./UNH_Membership_Project/project/volume/data/processed/Final_Direct.csv')
Final_OTP <- fread('./UNH_Membership_Project/project/volume/data/processed/Final_OTP.csv')
Final_Comp <- fread('./UNH_Membership_Project/project/volume/data/processed/Final_Comp.csv')
Final_Bundle <- fread('./UNH_Membership_Project/project/volume/data/processed/Final_Bundle.csv')
Final_Direct$num <- 1
Final_OTP$num <- 2
Final_Comp$num <- 3
Final_Bundle$num <- 4
#Adding year of transaction to Final_Direct
Final_Direct$year[Final_Direct$`Transaction Date` >= as.Date('2016-01-01') & Final_Direct$`Transaction Date` <= as.Date('2016-12-31')] <- "2016"
Final_Direct$year[Final_Direct$`Transaction Date` >= as.Date('2017-01-01') & Final_Direct$`Transaction Date` <= as.Date('2017-12-31')] <- "2017"
Final_Direct$year[Final_Direct$`Transaction Date` >= as.Date('2018-01-01') & Final_Direct$`Transaction Date` <= as.Date('2018-12-31')] <- "2018"
Final_Direct$year[Final_Direct$`Transaction Date` >= as.Date('2019-01-01') & Final_Direct$`Transaction Date` <= as.Date('2019-12-31')] <- "2019"
Final_Direct$year[Final_Direct$`Transaction Date` >= as.Date('2020-01-01') & Final_Direct$`Transaction Date` <= as.Date('2020-12-31')] <- "2020"
Final_Direct$year[Final_Direct$`Transaction Date` >= as.Date('2021-01-01') & Final_Direct$`Transaction Date` <= as.Date('2021-12-31')] <- "2021"
#Adding year of transaction to Final_OTP
Final_OTP$year[Final_OTP$`Transaction Date` >= as.Date('2016-01-01') & Final_OTP$`Transaction Date` <= as.Date('2016-12-31')] <- "2016"
Final_OTP$year[Final_OTP$`Transaction Date` >= as.Date('2017-01-01') & Final_OTP$`Transaction Date` <= as.Date('2017-12-31')] <- "2017"
Final_OTP$year[Final_OTP$`Transaction Date` >= as.Date('2018-01-01') & Final_OTP$`Transaction Date` <= as.Date('2018-12-31')] <- "2018"
Final_OTP$year[Final_OTP$`Transaction Date` >= as.Date('2019-01-01') & Final_OTP$`Transaction Date` <= as.Date('2019-12-31')] <- "2019"
Final_OTP$year[Final_OTP$`Transaction Date` >= as.Date('2020-01-01') & Final_OTP$`Transaction Date` <= as.Date('2020-12-31')] <- "2020"
Final_OTP$year[Final_OTP$`Transaction Date` >= as.Date('2021-01-01') & Final_OTP$`Transaction Date` <= as.Date('2021-12-31')] <- "2021"
#Adding year of transaction to Final_Comp
Final_Comp$year[Final_Comp$`Transaction Date` >= as.Date('2016-01-01') & Final_Comp$`Transaction Date` <= as.Date('2016-12-31')] <- "2016"
Final_Comp$year[Final_Comp$`Transaction Date` >= as.Date('2017-01-01') & Final_Comp$`Transaction Date` <= as.Date('2017-12-31')] <- "2017"
Final_Comp$year[Final_Comp$`Transaction Date` >= as.Date('2018-01-01') & Final_Comp$`Transaction Date` <= as.Date('2018-12-31')] <- "2018"
Final_Comp$year[Final_Comp$`Transaction Date` >= as.Date('2019-01-01') & Final_Comp$`Transaction Date` <= as.Date('2019-12-31')] <- "2019"
Final_Comp$year[Final_Comp$`Transaction Date` >= as.Date('2020-01-01') & Final_Comp$`Transaction Date` <= as.Date('2020-12-31')] <- "2020"
Final_Comp$year[Final_Comp$`Transaction Date` >= as.Date('2021-01-01') & Final_Comp$`Transaction Date` <= as.Date('2021-12-31')] <- "2021"
#Adding year of transaction to Final_Bundle
Final_Bundle$year[Final_Bundle$`Transaction Date` >= as.Date('2016-01-01') & Final_Bundle$`Transaction Date` <= as.Date('2016-12-31')] <- "2016"
Final_Bundle$year[Final_Bundle$`Transaction Date` >= as.Date('2017-01-01') & Final_Bundle$`Transaction Date` <= as.Date('2017-12-31')] <- "2017"
Final_Bundle$year[Final_Bundle$`Transaction Date` >= as.Date('2018-01-01') & Final_Bundle$`Transaction Date` <= as.Date('2018-12-31')] <- "2018"
Final_Bundle$year[Final_Bundle$`Transaction Date` >= as.Date('2019-01-01') & Final_Bundle$`Transaction Date` <= as.Date('2019-12-31')] <- "2019"
Final_Bundle$year[Final_Bundle$`Transaction Date` >= as.Date('2020-01-01') & Final_Bundle$`Transaction Date` <= as.Date('2020-12-31')] <- "2020"
Final_Bundle$year[Final_Bundle$`Transaction Date` >= as.Date('2021-01-01') & Final_Bundle$`Transaction Date` <= as.Date('2021-12-31')] <- "2021"
merged <- bind_rows(Final_Direct, Final_OTP, Final_Comp, Final_Bundle)
setorder(merged, cols = `Order Id`)
merged <- as.data.frame(merged)
merged <- merged[!duplicated(merged[c('Unique ID', 'year')]),]
merged <- as.data.table(merged)
str(merged)
as.numeric(merged$year)
merged <- as.data.table(merged)
str(merged)
merged<- as.numeric(merged$year)
str(merged)
Final_Direct <- fread('./UNH_Membership_Project/project/volume/data/processed/Final_Direct.csv')
Final_OTP <- fread('./UNH_Membership_Project/project/volume/data/processed/Final_OTP.csv')
Final_Comp <- fread('./UNH_Membership_Project/project/volume/data/processed/Final_Comp.csv')
Final_Bundle <- fread('./UNH_Membership_Project/project/volume/data/processed/Final_Bundle.csv')
Final_Direct$num <- 1
Final_OTP$num <- 2
Final_Comp$num <- 3
Final_Bundle$num <- 4
#Adding year of transaction to Final_Direct
Final_Direct$year[Final_Direct$`Transaction Date` >= as.Date('2016-01-01') & Final_Direct$`Transaction Date` <= as.Date('2016-12-31')] <- "2016"
Final_Direct$year[Final_Direct$`Transaction Date` >= as.Date('2017-01-01') & Final_Direct$`Transaction Date` <= as.Date('2017-12-31')] <- "2017"
Final_Direct$year[Final_Direct$`Transaction Date` >= as.Date('2018-01-01') & Final_Direct$`Transaction Date` <= as.Date('2018-12-31')] <- "2018"
Final_Direct$year[Final_Direct$`Transaction Date` >= as.Date('2019-01-01') & Final_Direct$`Transaction Date` <= as.Date('2019-12-31')] <- "2019"
Final_Direct$year[Final_Direct$`Transaction Date` >= as.Date('2020-01-01') & Final_Direct$`Transaction Date` <= as.Date('2020-12-31')] <- "2020"
Final_Direct$year[Final_Direct$`Transaction Date` >= as.Date('2021-01-01') & Final_Direct$`Transaction Date` <= as.Date('2021-12-31')] <- "2021"
#Adding year of transaction to Final_OTP
Final_OTP$year[Final_OTP$`Transaction Date` >= as.Date('2016-01-01') & Final_OTP$`Transaction Date` <= as.Date('2016-12-31')] <- "2016"
Final_OTP$year[Final_OTP$`Transaction Date` >= as.Date('2017-01-01') & Final_OTP$`Transaction Date` <= as.Date('2017-12-31')] <- "2017"
Final_OTP$year[Final_OTP$`Transaction Date` >= as.Date('2018-01-01') & Final_OTP$`Transaction Date` <= as.Date('2018-12-31')] <- "2018"
Final_OTP$year[Final_OTP$`Transaction Date` >= as.Date('2019-01-01') & Final_OTP$`Transaction Date` <= as.Date('2019-12-31')] <- "2019"
Final_OTP$year[Final_OTP$`Transaction Date` >= as.Date('2020-01-01') & Final_OTP$`Transaction Date` <= as.Date('2020-12-31')] <- "2020"
Final_OTP$year[Final_OTP$`Transaction Date` >= as.Date('2021-01-01') & Final_OTP$`Transaction Date` <= as.Date('2021-12-31')] <- "2021"
#Adding year of transaction to Final_Comp
Final_Comp$year[Final_Comp$`Transaction Date` >= as.Date('2016-01-01') & Final_Comp$`Transaction Date` <= as.Date('2016-12-31')] <- "2016"
Final_Comp$year[Final_Comp$`Transaction Date` >= as.Date('2017-01-01') & Final_Comp$`Transaction Date` <= as.Date('2017-12-31')] <- "2017"
Final_Comp$year[Final_Comp$`Transaction Date` >= as.Date('2018-01-01') & Final_Comp$`Transaction Date` <= as.Date('2018-12-31')] <- "2018"
Final_Comp$year[Final_Comp$`Transaction Date` >= as.Date('2019-01-01') & Final_Comp$`Transaction Date` <= as.Date('2019-12-31')] <- "2019"
Final_Comp$year[Final_Comp$`Transaction Date` >= as.Date('2020-01-01') & Final_Comp$`Transaction Date` <= as.Date('2020-12-31')] <- "2020"
Final_Comp$year[Final_Comp$`Transaction Date` >= as.Date('2021-01-01') & Final_Comp$`Transaction Date` <= as.Date('2021-12-31')] <- "2021"
#Adding year of transaction to Final_Bundle
Final_Bundle$year[Final_Bundle$`Transaction Date` >= as.Date('2016-01-01') & Final_Bundle$`Transaction Date` <= as.Date('2016-12-31')] <- "2016"
Final_Bundle$year[Final_Bundle$`Transaction Date` >= as.Date('2017-01-01') & Final_Bundle$`Transaction Date` <= as.Date('2017-12-31')] <- "2017"
Final_Bundle$year[Final_Bundle$`Transaction Date` >= as.Date('2018-01-01') & Final_Bundle$`Transaction Date` <= as.Date('2018-12-31')] <- "2018"
Final_Bundle$year[Final_Bundle$`Transaction Date` >= as.Date('2019-01-01') & Final_Bundle$`Transaction Date` <= as.Date('2019-12-31')] <- "2019"
Final_Bundle$year[Final_Bundle$`Transaction Date` >= as.Date('2020-01-01') & Final_Bundle$`Transaction Date` <= as.Date('2020-12-31')] <- "2020"
Final_Bundle$year[Final_Bundle$`Transaction Date` >= as.Date('2021-01-01') & Final_Bundle$`Transaction Date` <= as.Date('2021-12-31')] <- "2021"
merged <- bind_rows(Final_Direct, Final_OTP, Final_Comp, Final_Bundle)
setorder(merged, cols = `Order Id`)
merged <- as.data.frame(merged)
merged <- merged[!duplicated(merged[c('Unique ID', 'year')]),]
merged <- as.data.table(merged)
str(merged)
merged$year<- as.numeric(merged$year)
str(merged)
#Separate table back into Direct, OTP, Comp, or Bundle
Final_Direct <- merged[merged$num == 1]
Final_OTP <- merged[merged$num == 2]
Final_Comp <- merged[merged$num == 3]
Final_Bundle <- merged[merged$num == 4]
Final_Direct <- Final_Direct[, 'num':=NULL]
Final_OTP <- Final_OTP[, 'num':=NULL]
Final_Comp <- Final_Comp[, 'num':=NULL]
Final_Bundle <- Final_Bundle[, 'num':=NULL]
##############
#Direct Yearly
Direct_yearly = dcast(Final_Direct, `Unique ID` ~ year)
Direct_yearly <- Direct_yearly[,"NA":=NULL]
for(j in 2:ncol(Direct_yearly)){
set(Direct_yearly, i= which(Direct_yearly[[j]]!=0), j=j, value =1)
}
###########
#OTP Yearly
OTP_yearly = dcast(Final_OTP, `Unique ID` ~ year)
OTP_yearly <- OTP_yearly[,"NA":=NULL]
for(j in 2:ncol(OTP_yearly)){
set(OTP_yearly, i= which(OTP_yearly[[j]]!=0), j=j, value =2)
}
Total_yearly<-rbind(Direct_yearly, OTP_yearly)
############
#Comp Yearly
Comp_yearly = dcast(Final_Comp, `Unique ID` ~ year)
Comp_yearly <- Comp_yearly[,"NA":=NULL]
for(j in 2:ncol(Comp_yearly)){
set(Comp_yearly, i= which(Comp_yearly[[j]]!=0), j=j, value =3)
}
Total_yearly<-rbind(Total_yearly, Comp_yearly)
##############
#Bundle Yearly
Bundle_yearly = dcast(Final_Bundle, `Unique ID` ~ year)
Bundle_yearly <- Bundle_yearly[,"NA":=NULL]
for(j in 2:ncol(Bundle_yearly)){
set(Bundle_yearly, i= which(Bundle_yearly[[j]]!=0), j=j, value =4)
}
Total_yearly<-rbind(Total_yearly, Bundle_yearly)
Total_yearly[is.na(Total_yearly)] <- 0
str(Total_yearly)
Total_yearly <- Total_yearly[,.(`2016`=sum(`2016`), `2017`=sum(`2017`), `2018`=sum(`2018`), `2019`=sum(`2019`), `2020`=sum(`2020`), `2021`=sum(`2021`)), `Unique ID`]
Final_Direct <- fread('./UNH_Membership_Project/project/volume/data/processed/Final_Direct.csv')
Final_OTP <- fread('./UNH_Membership_Project/project/volume/data/processed/Final_OTP.csv')
Final_Comp <- fread('./UNH_Membership_Project/project/volume/data/processed/Final_Comp.csv')
Final_Bundle <- fread('./UNH_Membership_Project/project/volume/data/processed/Final_Bundle.csv')
Final_Direct$num <- 1
Final_OTP$num <- 2
Final_Comp$num <- 3
Final_Bundle$num <- 4
#Adding year of transaction to Final_Direct
Final_Direct$year[Final_Direct$`Transaction Date` >= as.Date('2016-01-01') & Final_Direct$`Transaction Date` <= as.Date('2016-12-31')] <- "2016"
Final_Direct$year[Final_Direct$`Transaction Date` >= as.Date('2017-01-01') & Final_Direct$`Transaction Date` <= as.Date('2017-12-31')] <- "2017"
Final_Direct$year[Final_Direct$`Transaction Date` >= as.Date('2018-01-01') & Final_Direct$`Transaction Date` <= as.Date('2018-12-31')] <- "2018"
Final_Direct$year[Final_Direct$`Transaction Date` >= as.Date('2019-01-01') & Final_Direct$`Transaction Date` <= as.Date('2019-12-31')] <- "2019"
Final_Direct$year[Final_Direct$`Transaction Date` >= as.Date('2020-01-01') & Final_Direct$`Transaction Date` <= as.Date('2020-12-31')] <- "2020"
Final_Direct$year[Final_Direct$`Transaction Date` >= as.Date('2021-01-01') & Final_Direct$`Transaction Date` <= as.Date('2021-12-31')] <- "2021"
#Adding year of transaction to Final_OTP
Final_OTP$year[Final_OTP$`Transaction Date` >= as.Date('2016-01-01') & Final_OTP$`Transaction Date` <= as.Date('2016-12-31')] <- "2016"
Final_OTP$year[Final_OTP$`Transaction Date` >= as.Date('2017-01-01') & Final_OTP$`Transaction Date` <= as.Date('2017-12-31')] <- "2017"
Final_OTP$year[Final_OTP$`Transaction Date` >= as.Date('2018-01-01') & Final_OTP$`Transaction Date` <= as.Date('2018-12-31')] <- "2018"
Final_OTP$year[Final_OTP$`Transaction Date` >= as.Date('2019-01-01') & Final_OTP$`Transaction Date` <= as.Date('2019-12-31')] <- "2019"
Final_OTP$year[Final_OTP$`Transaction Date` >= as.Date('2020-01-01') & Final_OTP$`Transaction Date` <= as.Date('2020-12-31')] <- "2020"
Final_OTP$year[Final_OTP$`Transaction Date` >= as.Date('2021-01-01') & Final_OTP$`Transaction Date` <= as.Date('2021-12-31')] <- "2021"
#Adding year of transaction to Final_Comp
Final_Comp$year[Final_Comp$`Transaction Date` >= as.Date('2016-01-01') & Final_Comp$`Transaction Date` <= as.Date('2016-12-31')] <- "2016"
Final_Comp$year[Final_Comp$`Transaction Date` >= as.Date('2017-01-01') & Final_Comp$`Transaction Date` <= as.Date('2017-12-31')] <- "2017"
Final_Comp$year[Final_Comp$`Transaction Date` >= as.Date('2018-01-01') & Final_Comp$`Transaction Date` <= as.Date('2018-12-31')] <- "2018"
Final_Comp$year[Final_Comp$`Transaction Date` >= as.Date('2019-01-01') & Final_Comp$`Transaction Date` <= as.Date('2019-12-31')] <- "2019"
Final_Comp$year[Final_Comp$`Transaction Date` >= as.Date('2020-01-01') & Final_Comp$`Transaction Date` <= as.Date('2020-12-31')] <- "2020"
Final_Comp$year[Final_Comp$`Transaction Date` >= as.Date('2021-01-01') & Final_Comp$`Transaction Date` <= as.Date('2021-12-31')] <- "2021"
#Adding year of transaction to Final_Bundle
Final_Bundle$year[Final_Bundle$`Transaction Date` >= as.Date('2016-01-01') & Final_Bundle$`Transaction Date` <= as.Date('2016-12-31')] <- "2016"
Final_Bundle$year[Final_Bundle$`Transaction Date` >= as.Date('2017-01-01') & Final_Bundle$`Transaction Date` <= as.Date('2017-12-31')] <- "2017"
Final_Bundle$year[Final_Bundle$`Transaction Date` >= as.Date('2018-01-01') & Final_Bundle$`Transaction Date` <= as.Date('2018-12-31')] <- "2018"
Final_Bundle$year[Final_Bundle$`Transaction Date` >= as.Date('2019-01-01') & Final_Bundle$`Transaction Date` <= as.Date('2019-12-31')] <- "2019"
Final_Bundle$year[Final_Bundle$`Transaction Date` >= as.Date('2020-01-01') & Final_Bundle$`Transaction Date` <= as.Date('2020-12-31')] <- "2020"
Final_Bundle$year[Final_Bundle$`Transaction Date` >= as.Date('2021-01-01') & Final_Bundle$`Transaction Date` <= as.Date('2021-12-31')] <- "2021"
#if account ID and year of record is the same, then only keep record with lower Order ID number
#trying to fix the problem where a customer bought multiple memberships in a year
merged <- bind_rows(Final_Direct, Final_OTP, Final_Comp, Final_Bundle)
setorder(merged, cols = `Order Id`)
merged <- as.data.frame(merged)
merged <- merged[!duplicated(merged[c('Unique ID', 'year')]),]
merged <- as.data.table(merged)
str(merged)
merged$year<- as.numeric(merged$year)
str(merged)
#Separate table back into Direct, OTP, Comp, or Bundle
Final_Direct <- merged[merged$num == 1]
Final_OTP <- merged[merged$num == 2]
Final_Comp <- merged[merged$num == 3]
Final_Bundle <- merged[merged$num == 4]
Final_Direct <- Final_Direct[, 'num':=NULL]
Final_OTP <- Final_OTP[, 'num':=NULL]
Final_Comp <- Final_Comp[, 'num':=NULL]
Final_Bundle <- Final_Bundle[, 'num':=NULL]
##############
#Direct Yearly
Direct_yearly = dcast(Final_Direct, `Unique ID` ~ year)
Direct_yearly <- Direct_yearly[,"NA":=NULL]
for(j in 2:ncol(Direct_yearly)){
set(Direct_yearly, i= which(Direct_yearly[[j]]!=0), j=j, value =1)
}
###########
#OTP Yearly
OTP_yearly = dcast(Final_OTP, `Unique ID` ~ year)
OTP_yearly <- OTP_yearly[,"NA":=NULL]
for(j in 2:ncol(OTP_yearly)){
set(OTP_yearly, i= which(OTP_yearly[[j]]!=0), j=j, value =2)
}
Total_yearly<-rbind(Direct_yearly, OTP_yearly)
############
#Comp Yearly
Comp_yearly = dcast(Final_Comp, `Unique ID` ~ year)
Comp_yearly <- Comp_yearly[,"NA":=NULL]
for(j in 2:ncol(Comp_yearly)){
set(Comp_yearly, i= which(Comp_yearly[[j]]!=0), j=j, value =3)
}
Total_yearly<-rbind(Total_yearly, Comp_yearly)
##############
#Bundle Yearly
Bundle_yearly = dcast(Final_Bundle, `Unique ID` ~ year)
Bundle_yearly <- Bundle_yearly[,"NA":=NULL]
for(j in 2:ncol(Bundle_yearly)){
set(Bundle_yearly, i= which(Bundle_yearly[[j]]!=0), j=j, value =4)
}
Total_yearly<-rbind(Total_yearly, Bundle_yearly)
View(Total_yearly)
Total_yearly[is.na(Total_yearly)] <- 0
str(Total_yearly)
Total_yearly <- Total_yearly[,.(`2016`=sum(`2016`), `2017`=sum(`2017`), `2018`=sum(`2018`), `2019`=sum(`2019`), `2020`=sum(`2020`), `2021`=sum(`2021`)), `Unique ID`]
View(Total_yearly)
data_4 <- data[data$`Unique ID` == "305058"]
View(data_4)
data7 <- Total_yearly[Total_yearly$`Unique ID` == "305058"]
View(data7)
